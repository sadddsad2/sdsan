name: SOCKS5 Proxy Validator

on:
  schedule:
    - cron: '0 14 * * *'  # åŒ—äº¬æ—¶é—´ 22:00
  workflow_dispatch:

# Add permissions for the workflow
permissions:
  contents: write
  
jobs:
  validate-proxies:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: Setup scanner
      run: |
        git clone https://github.com/Yariya/Zmap-ProxyScanner.git
        cd Zmap-ProxyScanner
        go build -o ../proxy-scanner
        cd ..
        
    - name: Create config
      run: |
        cat > config.json << 'EOF'
        {
          "check-site": "https://google.com",
          "proxy-type": "socks5",
          "http_threads": 5000,
          "headers": {
            "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
            "accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"
          },
          "print_ips": {
            "enabled": false,
            "display-ip-info": false
          },
          "timeout": {
            "http_timeout": 3,
            "socks4_timeout": 3,
            "socks5_timeout": 3
          }
        }
        EOF
        
    - name: Fetch proxy sources from url.txt
      run: |
        mkdir -p raw
        
        # æ£€æŸ¥ url.txt æ˜¯å¦å­˜åœ¨
        if [ ! -f "url.txt" ]; then
          echo "Error: url.txt not found!"
          echo "Please create url.txt with one proxy source URL per line"
          exit 1
        fi
        
        # è¯»å– url.txt å¹¶ä¸‹è½½æ¯ä¸ªæº
        line_num=0
        while IFS= read -r url || [ -n "$url" ]; do
          # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
          if [ -z "$url" ] || [[ "$url" =~ ^[[:space:]]*# ]]; then
            continue
          fi
          
          line_num=$((line_num + 1))
          echo "Fetching source $line_num: $url"
          
          # ä¸‹è½½ä»£ç†åˆ—è¡¨
          curl -fsSL --connect-timeout 10 --max-time 30 "$url" \
            -o "raw/source_${line_num}.txt" || {
            echo "Warning: Failed to fetch $url"
            continue
          }
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ
          if [ -s "raw/source_${line_num}.txt" ]; then
            echo "âœ“ Successfully fetched source $line_num ($(wc -l < raw/source_${line_num}.txt) lines)"
          else
            echo "âœ— Empty response from source $line_num"
            rm -f "raw/source_${line_num}.txt"
          fi
          
        done < url.txt
        
        # ç»Ÿè®¡ä¸‹è½½çš„æºæ•°é‡
        source_count=$(ls -1 raw/*.txt 2>/dev/null | wc -l)
        echo ""
        echo "================================"
        echo "Total sources downloaded: $source_count"
        echo "================================"
        
    - name: Merge and deduplicate
      run: |
        # åˆå¹¶æ‰€æœ‰æº
        cat raw/*.txt 2>/dev/null | \
          grep -E '^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}:[0-9]+$' | \
          sort -u > all_proxies.txt
          
        total_unique=$(wc -l < all_proxies.txt)
        echo ""
        echo "================================"
        echo "Total unique proxies: $total_unique"
        echo "================================"
        
    - name: Validate proxies
      timeout-minutes: 30
      run: |
        if [ -s all_proxies.txt ]; then
          echo "Starting validation..."
          # FIX: Changed -input to -in
          ./proxy-scanner -in all_proxies.txt -o validated_proxies.txt || true
          
          if [ -s validated_proxies.txt ]; then
            echo "âœ“ Validation completed: $(wc -l < validated_proxies.txt) valid proxies"
          else
            echo "âœ— No valid proxies found"
          fi
        else
          echo "No proxies to validate"
          touch validated_proxies.txt
        fi
        
    - name: Format output
      run: |
        # ç¡®ä¿åªæœ‰ ip:port æ ¼å¼
        if [ -s validated_proxies.txt ]; then
          grep -E '^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}:[0-9]+$' validated_proxies.txt | \
            sort -t: -k2 -n | \
            sort -u > socks5_proxies.txt
        else
          touch socks5_proxies.txt
        fi
        
        TOTAL=$(wc -l < socks5_proxies.txt)
        DATE=$(date +%Y%m%d-%H%M%S)
        SOURCE_COUNT=$(ls -1 raw/*.txt 2>/dev/null | wc -l)
        
        echo "TOTAL_PROXIES=$TOTAL" >> $GITHUB_ENV
        echo "SCAN_DATE=$DATE" >> $GITHUB_ENV
        echo "SOURCE_COUNT=$SOURCE_COUNT" >> $GITHUB_ENV
        
        # åˆ›å»ºå¸¦æ—¥æœŸçš„å¤‡ä»½
        cp socks5_proxies.txt socks5_proxies_${DATE}.txt
        
        # ç»Ÿè®¡ä¿¡æ¯
        echo "## Scan Statistics" > stats.txt
        echo "" >> stats.txt
        echo "- Total validated: $TOTAL" >> stats.txt
        echo "- Scan date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> stats.txt
        echo "- Sources checked: $SOURCE_COUNT" >> stats.txt
        
    - name: Generate README
      run: |
        cat > README.md << 'ENDREADME'
        # ðŸŒ SOCKS5 Proxy List
        
        [![Update](https://github.com/${{ github.repository }}/actions/workflows/scan-proxies.yml/badge.svg)](https://github.com/${{ github.repository }}/actions)
        [![Proxies](https://img.shields.io/badge/proxies-${{ env.TOTAL_PROXIES }}-brightgreen)]()
        [![Updated](https://img.shields.io/badge/updated-${{ env.SCAN_DATE }}-blue)]()
        
        Automatically validated SOCKS5 proxies, updated daily at 22:00 Beijing Time.
        
        ## ðŸ“¥ Download
        
        **Latest:** [socks5_proxies.txt](https://github.com/${{ github.repository }}/releases/latest/download/socks5_proxies.txt)
        
        ## ðŸ“Š Statistics
        
        - **Total Proxies:** ${{ env.TOTAL_PROXIES }}
        - **Last Update:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - **Sources Used:** ${{ env.SOURCE_COUNT }}
        - **Format:** `ip:port`
        
        ## ðŸ”„ Update Schedule
        
        Automatically updates every day at 22:00 (UTC+8)
        
        ## âš™ï¸ Sources
        
        Proxies are fetched from sources listed in `url.txt` and validated before publishing.
        
        To add your own sources, edit `url.txt` (one URL per line).
        
        ## ðŸ“ Format
        
        ```
        1.2.3.4:1080
        5.6.7.8:1080
        9.10.11.12:9050
        ```
        
        ## âš ï¸ Disclaimer
        
        - Proxies collected from public internet
        - No guarantee of availability or security
        - Use at your own risk
        - Verify before use in production
        - Respect local laws and regulations
        
        ## ðŸ› ï¸ Usage Example
        
        ```bash
        # Download latest list
        curl -fsSL https://github.com/${{ github.repository }}/releases/latest/download/socks5_proxies.txt -o proxies.txt
        
        # Use with curl
        curl -x socks5://1.2.3.4:1080 https://api.ipify.org
        
        # Test connectivity
        curl --proxy socks5://1.2.3.4:1080 --connect-timeout 5 https://google.com
        ```
        
        ## ðŸ“œ License
        
        MIT License - Use freely with attribution
        
        ---
        
        **Note:** This list is for educational and testing purposes only.
        ENDREADME
        
    - name: Commit stats
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add README.md || true
        git diff --quiet && git diff --staged --quiet || {
          git commit -m "Update stats: ${{ env.TOTAL_PROXIES }} proxies"
          git push
        }
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.SCAN_DATE }}
        name: SOCKS5 Proxies ${{ env.SCAN_DATE }}
        body: |
          ## ðŸ“¡ SOCKS5 Proxy List
          
          **Valid Proxies:** ${{ env.TOTAL_PROXIES }}
          **Scan Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Sources:** ${{ env.SOURCE_COUNT }}
          
          ### ðŸ“¥ Download
          - [socks5_proxies.txt](https://github.com/${{ github.repository }}/releases/download/${{ env.SCAN_DATE }}/socks5_proxies.txt)
          
          ### ðŸ“‹ Format
          ```
          ip:port
          ```
          
          ### âš¡ Quick Test
          ```bash
          curl -x socks5://[IP]:[PORT] https://api.ipify.org
          ```
          
          ### âš ï¸ Warning
          - Public proxies may be insecure
          - Validate before production use
          - No guarantee of availability
          
        files: |
          socks5_proxies.txt
          socks5_proxies_*.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
